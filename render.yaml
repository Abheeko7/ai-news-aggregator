# Render Blueprint - AI News Aggregator
# https://render.com/docs/blueprint-spec
#
# Deploy from branch: deployment
#
# Creates:
# 1. PostgreSQL database (articles, digests)
# 2. Web service: /health, /trigger-newsletter (run full pipeline → send to MY_EMAIL)
# 3. Cron job: runs python main.py daily (scrape → process → digest → email)
#
# CRON_SECRET (web service only):
# - Used only when something calls POST /trigger-newsletter (e.g. external cron, manual curl).
# - Render cron runs main.py directly and does NOT use CRON_SECRET.
# - If you set CRON_SECRET: generate with `openssl rand -hex 24` or
#   `python -c "import secrets; print(secrets.token_urlsafe(32))"`, then paste
#   into Render "Enter value" for CRON_SECRET. Use same value in X-Cron-Secret
#   when calling /trigger-newsletter.
# - If you use only Render cron and never call /trigger-newsletter: leave empty.

databases:
  - name: ai-news-aggregator-db
    plan: free
    databaseName: ai_news_aggregator
    user: ai_news_user

services:
  - type: web
    name: ai-news-api
    runtime: python
    plan: free
    branch: deployment
    buildCommand: pip install -r requirements.txt && python app/database/create_tables.py
    startCommand: python run_api.py
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: ai-news-aggregator-db
          property: connectionString
      - key: PYTHON_VERSION
        value: "3.12.3"
      - key: PORT
        value: "5000"
      - key: CRON_SECRET
        sync: false   # Optional. Protect /trigger-newsletter; leave empty if only Render cron.
      - key: GEMINI_API_KEY
        sync: false
      - key: MY_EMAIL
        sync: false
      - key: APP_PASSWORD
        sync: false

  # Cron job: runs main.py daily. Requires paid plan (starter).
  - type: cron
    name: ai-news-daily-pipeline
    runtime: python
    plan: starter
    branch: deployment
    schedule: "0 8 * * *"   # Daily at 8:00 AM UTC
    buildCommand: pip install -r requirements.txt && python app/database/create_tables.py
    startCommand: python main.py
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: ai-news-aggregator-db
          property: connectionString
      - key: PYTHON_VERSION
        value: "3.12.3"
      - key: GEMINI_API_KEY
        sync: false
      - key: MY_EMAIL
        sync: false
      - key: APP_PASSWORD
        sync: false
