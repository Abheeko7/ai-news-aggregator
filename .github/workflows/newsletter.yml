name: Daily Newsletter Trigger

# Triggers the newsletter pipeline daily via Render /trigger-newsletter.
# Uses GitHub Actions (free) instead of Render cron (paid).
# Pipeline: scrape ‚Üí process ‚Üí digest ‚Üí send to MY_EMAIL.

on:
  schedule:
    - cron: '30 0 * * *'   # Daily at 00:30 UTC = 16:30 PST (change back to '0 8 * * *' for 8 AM UTC if preferred)
  workflow_dispatch:       # Manual trigger from GitHub Actions tab

jobs:
  trigger-newsletter:
    runs-on: ubuntu-latest
    name: Trigger Newsletter Pipeline
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Trigger Newsletter Endpoint
        env:
          RENDER_URL: ${{ secrets.RENDER_SERVICE_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "üöÄ Triggering newsletter pipeline..."
          echo "Service URL: $RENDER_URL"
          
          # Build curl command (add X-Cron-Secret only if CRON_SECRET is set)
          CURL_CMD="curl -s -w '\n%{http_code}' -X POST '$RENDER_URL/trigger-newsletter' -H 'Content-Type: application/json' --max-time 300"
          if [ -n "$CRON_SECRET" ]; then
            CURL_CMD="$CURL_CMD -H 'X-Cron-Secret: $CRON_SECRET'"
          fi
          
          # Retry up to 3 times (Render free tier cold starts can take 60‚Äì90s)
          max_attempts=3
          attempt=1
          http_code=000
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            response=$(eval "$CURL_CMD" || echo "000")
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n-1)
            
            echo "Response Code: $http_code"
            if [ "$http_code" = "200" ] || [ "$http_code" = "201" ] || [ "$http_code" = "202" ]; then
              echo "‚úÖ Newsletter pipeline triggered successfully!"
              echo "$body" | jq '.' 2>/dev/null || echo "$body"
              exit 0
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "‚ö†Ô∏è  Got $http_code (may be cold start). Waiting 45s before retry..."
              sleep 45
            fi
            attempt=$((attempt + 1))
          done
          
          echo "‚ùå Failed to trigger newsletter after $max_attempts attempts. HTTP Code: $http_code"
          echo "$body"
          exit 1
      
      - name: Display Summary
        if: success()
        run: |
          echo "üìß Pipeline started. Newsletter will be sent (check Render logs)."
          echo "Check Render service logs for details."
