name: Daily Newsletter Trigger

# Triggers the newsletter pipeline daily via Render /trigger-newsletter.
# Uses GitHub Actions (free) instead of Render cron (paid).
# Pipeline: scrape ‚Üí process ‚Üí digest ‚Üí send to MY_EMAIL.

on:
  schedule:
    - cron: '0 8 * * *'   # Daily at 8:00 AM UTC
  workflow_dispatch:       # Manual trigger from GitHub Actions tab

jobs:
  trigger-newsletter:
    runs-on: ubuntu-latest
    name: Trigger Newsletter Pipeline
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Trigger Newsletter Endpoint
        env:
          RENDER_URL: ${{ secrets.RENDER_SERVICE_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "üöÄ Triggering newsletter pipeline..."
          echo "Service URL: $RENDER_URL"
          
          CURL_CMD="curl -s -w '\n%{http_code}' -X POST '$RENDER_URL/trigger-newsletter' -H 'Content-Type: application/json'"
          if [ -n "$CRON_SECRET" ]; then
            CURL_CMD="$CURL_CMD -H 'X-Cron-Secret: $CRON_SECRET'"
          fi
          
          response=$(eval "$CURL_CMD" || echo "000")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "Response Code: $http_code"
          echo "Response Body: $body"
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "‚úÖ Newsletter pipeline triggered successfully!"
            echo "$body" | jq '.' 2>/dev/null || echo "$body"
          else
            echo "‚ùå Failed to trigger newsletter. HTTP Code: $http_code"
            echo "$body"
            exit 1
          fi
      
      - name: Display Summary
        if: success()
        run: |
          echo "üìß Pipeline completed. Newsletter sent to MY_EMAIL."
          echo "Check Render service logs for details."
